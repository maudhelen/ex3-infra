name: infra

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  RESOURCE_GROUP_DEV: aguadamillas_students_1
  SUBSCRIPTION_ID_DEV: e0b9cada-61bc-4b5a-bd7a-52c606726b3b
  USER_ALIAS: maudhelen

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Checkout code
      - uses: actions/checkout@v2

      # Lint Bicep code 
      - name: Run Bicep linter
        run: az bicep build --file ./main.bicep
    
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: 'Development'
    
    env:
      ENV: dev

    steps:
      # Checkout code
      - uses: actions/checkout@v2
    
      # Log into Azure
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Deploy Bicep file with parameters from parameters.json
      - name: Deploy
        run: |
          az deployment sub create \
            --template-file ./main.bicep \
            --parameters @"./parameters.json" \
            --name ${{ env.USER_ALIAS }} \
            --subscription ${{ env.SUBSCRIPTION_ID_DEV }} \
            --resource-group ${{ env.RESOURCE_GROUP_DEV }}
        env:
          AZURE_CONFIG_DIR: ${{ github.workspace }}
